<html>
<head>
<title>nar nar</title>
<style>

.fill {
    width: 100%;
    height: 100%;
}

table {
    border-collapse: collapse;
}
th, td {
    padding: 0;
}

.question {
}

.category {
    font-size: small;
    color: blue;
}

</style>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="https://raw.github.com/dglittle/myutil/master/u.js"></script>
<script src="https://raw.github.com/dglittle/myutil/master/jquery.timeago.js"></script>
<script>

g_version = 1

function onError(msg) {
    var div = $('<div style="padding:20px"/>')
    div.append($('<span/>').text(msg || "Oops. Not sure what happened."))
    div.append($('<br/>'))
    div.append($('<a href="#"/>').text("Please refresh the page.").click(function (e) {
        e.preventDefault()
        location.reload()
    }))
    _.dialog(div)
}

var g_rpc = []

function rpc(func, arg, cb) {
    if (!func) {
        var save_rpc = g_rpc
        g_rpc = []
        $.ajax({
            url : '/rpc',
            type : 'post',
            data : _.json(_.map(save_rpc, function (e) { return e.payload })),
            success : function (r) {
                for (var i = 0; i < r.length; i++) {
                    save_rpc[i].cb(r[i])
                }
            },
            error : function () {
                onError()
            }
        })
    } else {
        if (g_rpc.length == 0) {
            g_rpc.push({
                payload : { func : "getVersion" },
                cb : function (r) {
                    if (r != g_version) onError('This interface has been updated.')
                }
            })
        }
        g_rpc.push({
            payload : { func : func, arg : arg },
            cb : cb
        })
    }
}

function rpc_getUser() {
    rpc('getUser', null, function (user) {
        g_user = user
        var s = 'welcome ' + user.name
        g_upperRight.text(s)
    })
}

function drawTask(task) {
    var div = $('<div style="margin-top:20px"/>')

    div.append($('<img style="float:left;min-width:133px;min-height:100px;border:1px solid black"/>').attr('src', task.img || ''))

    var d2 = $('<div style="float:left;margin-left:10px;width:500px"/>')
    div.append(d2)
    d2.append($('<div/>').text(task.name))
    d2.append($('<div style="color:blue;font-family:monospace"/>').text(task.username))

    if (task.title)
        d2.append($('<div style="margin-top:10px"/>').text(task.title))
    if (task.overview)
        d2.append($('<div style="margin-top:10px"/>').text(task.overview))

    var buttons = $('<div style="margin-top:10px"/>')
    d2.append(buttons)

    function setAcceptRejectButtons() {
        var div = $('<div/>')
        var notes = null
        function myRpc() {
            task.notes = notes.val() || null
            if (!(task.notes == null || task.notes.match(/^[\s\S]{0,1024}$/))) {
                alert('sorry, the notes field is probably too long')
                return
            }
            rpc('submit', { task : task._id, status : task.status, notes : task.notes }, function () {})
            rpc()
            setButtons()
        }
        div.append($('<button style="float:left;height:4em;background:lightgreen"/>').text('accept').click(function () {
            task.status = 'accepted'
            myRpc()
        }))
        div.append($('<button style="float:left;height:4em;background:pink"/>').text('reject').click(function () {
            task.status = 'rejected'
            myRpc()
        }))
        div.append($('<button style="float:left;height:4em;background:lightyellow"/>').html('check in<br/>48 hours').click(function () {
            task.status = 'check again later'
            task.availableToGrabAt = _.time() + 1000 * 60 * 60 * 48
            myRpc()
        }))
        var d = $('<div style="float:left"/>')
        if (task.status == 'check again later') {
            d.append($('<span style="font-weight:bold"/>').text("it's been 48 hours!"))
        }
        d.append($('<button style=""/>').text('open obo').click(function () {
            window.open(task.obo, '_blank')
            window.focus() 
        }))
        d.append($('<br/>'))
        d.append($('<span/>').text('notes: '))
        d.append(notes = $('<input type="text" style="width:250px"/>'))
        notes.val(task.notes)
        div.append(d)
        div.append($('<div style="clear:both"/>'))
        buttons.empty().append(div)
    }

    function setUndoButton() {
        var div = $('<div/>')
        div.append($('<button style="float:left;height:4em;background:lightblue"/>').text('undo').click(function () {
            task.status = null
            rpc('submit', { task : task._id, status : task.status }, function () {})
            rpc()
            setAcceptRejectButtons()
        }))
        div.append($('<div style="float:left;font-weight:bold;color:' + (task.status == 'accepted' ? 'green' : (task.status == 'rejected') ? 'red' : 'yellow') + '"/>').text(task.status))
        if (task.notes)
            div.append($('<div style="float:left"/>').text(', notes: ' + task.notes))
        div.append($('<div style="clear:both"/>'))
        buttons.empty().append(div)
    }

    function setButtons() {
        if (task.status == null || (task.status == 'check again later' && _.time() + 1000 * 60 * 60 * 2 > task.availableToGrabAt)) {
            setAcceptRejectButtons()
        } else {
            setUndoButton()
        }
    }

    setButtons()

    div.append($('<div style="clear:both"/>'))

    return div
}

function rpc_grabBatch(forceNew) {
    rpc('grabBatch', forceNew, function (tasks) {
        var div = $('<div/>')
        _.each(tasks, function (task) {
            div.append(drawTask(task))
        })
        div.append($('<div style="clear:both"/>'))
        div.append($('<button style="margin-top:20px;width:133px;height:4em;background:yellow"/>').html('done, grab&nbsp;more&nbsp;tasks').click(function () {
            rpc_grabBatch(true)
            rpc_getTaskCount()
            rpc()
        }))
        g_output.empty().append(div)
    })
}

function rpc_getTaskCount() {
    rpc('getTaskCount', null, function (c) {
        g_upperLeft.text('tasks left: ' + c)
    })
}

$(function () {
    g_upperLeft = $('<div style="float:left">')
    g_upperRight = $('<div style="float:right"/>')
    g_output = $('<div class="fill"/>')

    var top = $('<div/>')
    top.append($('<div style="float:left;font-weight:bold;color:lightgreen;margin-right:20px"/>').text('nar nar'))
    top.append(g_upperLeft)
    top.append(g_upperRight)
    top.append($('<div style="clear:both"/>'))
    $('body').append(_.splitVert(0.01, null, top, g_output))

    rpc_getUser()
    rpc_grabBatch()
    rpc_getTaskCount()
    rpc()
})

</script>

</body>
</html>
